## 公共部分-srv类型

colcon build --symlink-install # 符号链接
添加
服务数据类型：**ControlService.srv**
```
string req   # send to service  # 发送给服务器的内容
---
string echo  # return from service # 服务器返回的内容

# 使用 from uav_car_interfaces.srv import ControlService
```
CMakeLists.txt添加：
```CMake
#  add message / service dependencies !!!
rosidl_generate_interfaces(${PROJECT_NAME}
"msg/T265Data.msg"
"msg/ImageProcessorData.msg"
"srv/ControlService.srv"
 )
```

##  服务端修改：

1. navigator.py

```python
第46行左右：
self.takeoff_service = self.create_service(Empty, "takeoff_service", self.takeoff_callback)

第96行左右：
def takeoff_callback(self, request, response):  # FIXME 回调：起飞

	self.get_logger().warning("takeoff service called")

	# wait for camera and t265 to be ready

	msg = "52 "  

	ur.uart_sender3_send(self, msg)  

	return response

---改之后---
from uav_car_interfaces.srv import ControlService

self.takeoff_service = self.create_service(ControlService, "takeoff_service", self.takeoff_callback)

---
def takeoff_callback(self, request, response):  # FIXME 回调：起飞
	self.get_logger().warning(f"{request.req} service called!!!")
	
    if request == "takeoff": # 纯字符串数据。起飞指令：'takeoff'不多空格
		ur.uart_sender3_send(self, "52 ")  # 让串口发送 起飞cmd 给 MCU控制板
		response = f'{request.req}OK' # 返回 请求字符串+OK大写字母，表示收到消息，已经执行
	
	return response

```



## 地面端修改：

1. ros2_ground_station.py
```python
def create_services(self):
	"""创建服务和客户端"""
	# 起飞服务客户端地面站 # 起飞服务客户端地面站# 起飞服务客户端地面站 
	self.takeoff_client = self.create_client(Empty, 'takeoff_service')
	self.get_logger().info('服务客户端创建完成')

def call_takeoff_service(self):
	"""调用起飞服务"""
	if not self.takeoff_client.wait_for_service(timeout_sec=1.0):
		self.get_logger().error('起飞服务不可用')
		return False
	request = Empty.Request()
	future = self.takeoff_client.call_async(request)
	# 这里可以添加回调处理
	self.get_logger().info('起飞服务请求已发送')
	return True
	
	
---改之后---

from uav_car_interfaces.srv import ControlService

#创建两个成员变量 不创建了，直接临时变量即可， 避免出错
#self.CS_request = ControlService.Request()
#self.CS_response = ControlService.Response()

def create_services(self):
	"""创建服务和客户端"""
	# 起飞服务客户端地面站 # 起飞服务客户端地面站# 起飞服务客户端地面站 
	self.takeoff_client = self.create_client(ControlService, 'takeoff_service')
	self.get_logger().info('服务客户端创建完成')

---

def call_takeoff_service(self, req):
	"""调用xxx服务"""
	if not self.takeoff_client.wait_for_service(timeout_sec=1.5):
		self.get_logger().error('起飞服务不可用')
		return False
	request = ControlService.Request()
	request.req = req
	#if req == "takeoff":
	future = self.takeoff_client.call_async(request)
	# future.add_done_callback(self.your_callback) # full async callback # 这里可以添加回调处理
	self.get_logger().info('起飞服务请求已发送')
	return True
#def your_callback(self,future):
#	# self.response = future.result()
#	self.get_logger().info(f'Received reply: "{future.result().echo}"')

--- 

colcon build --symlink-install # 符号链接
``` 


## 问题 t265 node未启动！！ 无打印日志！！！

![](assets/添加服务/file-20251224230635351.png)
```
orangepi@orangepiWJH:~/Desktop/UAV_CAR__Test/UAV_CAR$ colcon build
Starting >>> uav_car_interfaces
Finished <<< uav_car_interfaces [0.71s]
Starting >>> uav_car
Starting >>> uav_car_launch
Starting >>> uav_car_unit
/usr/local/lib/python3.8/dist-packages/setuptools/dist.py:710: UserWarning: Usage of dash-separated 'script-dir' will not be supported in future versions. Please use the underscore name 'script_dir' instead
  warnings.warn(
/usr/local/lib/python3.8/dist-packages/setuptools/dist.py:710: UserWarning: Usage of dash-separated 'install-scripts' will not be supported in future versions. Please use the underscore name 'install_scripts' instead
  warnings.warn(
/usr/local/lib/python3.8/dist-packages/setuptools/dist.py:710: UserWarning: Usage of dash-separated 'script-dir' will not be supported in future versions. Please use the underscore name 'script_dir' instead
  warnings.warn(
/usr/local/lib/python3.8/dist-packages/setuptools/dist.py:710: UserWarning: Usage of dash-separated 'install-scripts' will not be supported in future versions. Please use the underscore name 'install_scripts' instead
  warnings.warn(
/usr/local/lib/python3.8/dist-packages/setuptools/dist.py:710: UserWarning: Usage of dash-separated 'script-dir' will not be supported in future versions. Please use the underscore name 'script_dir' instead
  warnings.warn(
/usr/local/lib/python3.8/dist-packages/setuptools/dist.py:710: UserWarning: Usage of dash-separated 'install-scripts' will not be supported in future versions. Please use the underscore name 'install_scripts' instead
  warnings.warn(
--- stderr: uav_car_launch
/usr/local/lib/python3.8/dist-packages/setuptools/dist.py:710: UserWarning: Usage of dash-separated 'script-dir' will not be supported in future versions. Please use the underscore name 'script_dir' instead
  warnings.warn(
---
Finished <<< uav_car_launch [2.43s]
--- stderr: uav_car
/usr/local/lib/python3.8/dist-packages/setuptools/dist.py:710: UserWarning: Usage of dash-separated 'script-dir' will not be supported in future versions. Please use the underscore name 'script_dir' instead
  warnings.warn(
---
Finished <<< uav_car [2.50s]
--- stderr: uav_car_unit
/usr/local/lib/python3.8/dist-packages/setuptools/dist.py:710: UserWarning: Usage of dash-separated 'script-dir' will not be supported in future versions. Please use the underscore name 'script_dir' instead
  warnings.warn(
---
Finished <<< uav_car_unit [2.49s]

Summary: 4 packages finished [3.55s]

```