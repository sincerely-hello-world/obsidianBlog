## rk3588s配置环境

下载镜像，烧录到SD卡，
```
$ lsb_release -a 
Distributor ID: Ubuntu
Description:    Ubuntu 20.04.6 LTS
Release:        20.04
Codename:       focal

$ uname -a
Linux orangepi5b 6.1.43-rockchip-rk3588 #1.0.10 SMP Thu Jul  4 01:52:00 CST 2024 aarch64 aarch64 aarch64 GNU/Linux

版本 Ubuntu20.04 focal 6.1.43-rockchip-rk3588(官方版本)
```

## 安装ros2

[Foxy ROS2安装](Foxy%20ROS2安装.md)

## 1. 安装nomachine？ 选配



## 2. 模块包安装
```bash
sudo apt install python3-pip  -y

sudo pip3 install python-periphery # GPIO驱动库
sudo pip3 install pyserial # 串口通信
# sudo pip3 install pyrealsense2  # t265 传感器模块 # 这个默认的不可以，需要从源码构建！建议v2.51.1

sudo apt-get install  python3-dev -y


## opencv模块  cv_bridge模块！
# sudo apt-get install -y ros-foxy-cv-bridge # cv-bridge在 ros2 cli默认不装，自己手动装上

# opencv会被上述依赖，自动安装，不需要特意指定 sudo apt-get install -y python3-opencv  # opencv

sudo apt-get install -y python3-numpy   # numpy

```

```bash
sudo pip3 install -y rknn_toolkit_lite2-x.y.z-cp38-cp38-linux_aarch64.whl 

# rknn-lite 图像推理
# 这个也可以，会默认匹配当前python版本，但最好指定版本sudo pip3 install   rknn-toolkit-lite2 -y # 当然，这个包也可以从github下载，本地安装

这里下载
https://github.com/rockchip-linux/rknn-toolkit2/tree/master/rknpu2/runtime/Linux/librknn_api/aarch64

# 如果遇到 无法加载rknn model v6版本模型, 更新 librknnrt.so 动态库，
https://github.com/airockchip/rknn-toolkit2/blob/master/rknpu2/runtime/Linux/librknn_api/aarch64 # 把最新的librknnrt.so下载下来
 sudo cp /usr/lib/librknnrt.so /usr/lib/librknnrt.so.backup
 sudo cp librknnrt.so /usr/lib/librknnrt.so
```


测试一下 opencv 和 cv_bridge的是否可以使用
```python
python3
import cv2 # 先导入cv2,再导入cv_bridge！
from cv_bridge import CvBridge
```
 



其他
```bash
# 添加pip3安装的一些包，到环境变量，解决warning
echo 'export PATH=/home/orangepi/.local/bin:$PATH' >> ~/.bashrc
source ~/.bashrc

# 只需执行一次，以后所有新终端都自动有 ROS 2 环境
# echo "source /opt/ros/foxy/setup.bash" >> ~/.bashrc 
# source  ~/.bashrc 

# >> 表示追加写入， > 表示覆盖写入（千万别覆盖写入）
```
---

## 开发板外设使能

[orangepi 5B 引脚说明图](http://www.orangepi.cn/orangepiwiki/index.php/26_Pin_%E6%8E%A5%E5%8F%A3%E5%BC%95%E8%84%9A%E8%AF%B4%E6%98%8E)

```bash
### 开启/使能 开发板uart0 1 3 4 口

# 编辑 orangepiEnv.txt
sudo vim /boot/orangepiEnv.txt
# 附加写入：overlays=uart0-m2 uart1-m1 uart3-m0 uart4-m0
# 如果overlays=前面已经有符号，空格间隔 追加写入!
overlays=uart0-m2 uart1-m1 uart3-m0 uart4-m0
# wq退出
reboot # 重启生效
---------------------------
$ ls /dev | grep ttyS # S0 1 3 4 为串口0 1 3 4; 串口2可能作为调试串口了
ttyS0
ttyS1
ttyS3
ttyS4
ttyS9
---------------------------
$ cat /boot/orangepiEnv.txt 
verbosity=1
bootlogo=true
extraargs=cma=128M
overlay_prefix=rk3588
fdtfile=rockchip/rk3588s-orangepi-5b.dtb
rootdev=UUID=1a81526c-22b9-4b80-94ed-769e3f1c6963
rootfstype=ext4
overlays=uart0-m2 uart1-m1 uart3-m0 uart4-m0
```

### 开启/使能 开发板pwm 
```bash
# 编辑 orangepiEnv.txt
sudo vim /boot/orangepiEnv.txt
sudo cat /boot/orangepiEnv.txt
# 附加写入：overlays=pwm3-m0 pwm14-m1 
# 如果overlays=前面已经有符号如uart0-m2 uart1-m1 uart3-m0 uart4-m0，空格间隔 追加写入!
overlays=pwm3-m0 pwm14-m1 

-----------------------------

orangepi@orangepiWJH:/etc/udev/rules.d$ ls /sys/class/pwm -l
总用量 0
lrwxrwxrwx 1 root root 0 1月   1  2021 pwmchip0 -> ../../devices/platform/fd8b0020.pwm/pwm/pwmchip0
lrwxrwxrwx 1 root root 0 1月   1  2021 pwmchip1 -> ../../devices/platform/fd8b0030.pwm/pwm/pwmchip1
lrwxrwxrwx 1 root root 0 1月   1  2021 pwmchip2 -> ../../devices/platform/febd0020.pwm/pwm/pwmchip2
lrwxrwxrwx 1 root root 0 1月   1  2021 pwmchip3 -> ../../devices/platform/febf0020.pwm/pwm/pwmchip3

-----------------------------
# 我们要使用          pwm3-m0   pwm14-m1 
# 寄存器度地址分别是： fd8b0030  febf0020
# gpio序号           28        138
# pwmchip组          pwmchip1  pwmchip3

```

## 使能外设-最终的`/boot/orangepiEnv.txt`如下：

```bash
verbosity=1
bootlogo=true
extraargs=cma=128M
overlay_prefix=rk3588
fdtfile=rockchip/rk3588s-orangepi-5b.dtb
rootdev=UUID=1a81526c-22b9-4b80-94ed-769e3f1c6963
rootfstype=ext4
overlays=uart0-m2 uart1-m1 uart3-m0 uart4-m0 pwm3-m0 pwm14-m1
```

---


```
| 用户组  | 序号  | GPIO     | 复用         | 功能描述    | chip | channel |
| ---- | --- | -------- | ---------- | ------- | ---- | ------- |
| pwm  | 138 | GPIO4_B2 | PWM14_M1   | 舵机1     | 1    | 0       |
| pwm  | 28  | GPIO0_D4 | PWM3_IR_M0 | 舵机2     | 3    | 0       |
| gpio | 54  | GPIO1_C6 |            | 激光笔  开关 |      |         |
| gpio | 35  | GPIO1_A3 |            | 激光笔  开关 |      |         |

```

---
## 修改用户组权限，避免每次都sudo 执行？

因为 python访问外设，需要root权限，所以脚本需要sudo运行。

gpio pwm不设置用户组， 直接运行，会报错：
```json
[image_processor-5] Traceback (most recent call last):
[image_processor-5]   File "/usr/local/lib/python3.8/dist-packages/periphery/gpio_sysfs.py", line 63, in _open
[image_processor-5]     with open("/sys/class/gpio/export", "w") as f_export:
[image_processor-5] PermissionError: [Errno 13] Permission denied: '/sys/class/gpio/export'

[image_processor-5] During handling of the above exception, another exception occurred:
[image_processor-5]   File "/usr/local/lib/python3.8/dist-packages/periphery/gpio_sysfs.py", line 45, in __init__
[image_processor-5]     self._open(line, direction)
[image_processor-5]   File "/usr/local/lib/python3.8/dist-packages/periphery/gpio_sysfs.py", line 66, in _open
[image_processor-5]     raise GPIOError(e.errno, "Exporting GPIO: " + e.strerror)
[image_processor-5] periphery.gpio.GPIOError: [Errno 13] Exporting GPIO: Permission denied
```

如果可以使用udev规则，修改用户组权限，可以避免这个过程，直接正常启动。

---

# 设置udev规则（未完待续）

```bash
echo $USER # 查询当前用户名
groups $USER # 查询当前用户 所属 用户组
# 查询总的 group 配置
# cat /etc/group
```

设置gpio 和 pwm 用户组
```bash
# 添加到用户组
sudo groupadd gpio 
sudo groupadd pwm

sudo usermod -aG gpio,pwm $USER
groups $USER 
```

修改用户组规则
```bash
# 
cd /etc/udev/rules.d/ &&  sudo vi 99-rockchip-permissions.rules
ls # 一般是99-* ， 表示用户最后自定义的规则，最后进行的规则变动
sudo vi 99-rockchip-permissions.rules

```
添加这些规则
```bash 
KERNEL=="gpiochip*", SUBSYSTEM=="gpio", MODE="0660", GROUP="gpio"
KERNEL=="pwmchip*",SUBSYSTEM=="pwm",   MODE="0660", GROUP="pwm"
```

刷新规则：
```bash
# 重载规则 
sudo udevadm control --reload-rules  && sudo udevadm trigger --subsystem-match=gpio
sudo udevadm control --reload-rules  && sudo udevadm trigger --subsystem-match=pwm
# 触发 gpio 子系统的设备重新应用规则 
ls  -l /dev/gpiochip*

ls  -l  /sys/class/pwm/
```



```bash
SUBSYSTEM=="gpio", KERNEL=="gpiochip*", ACTION=="add", RUN+="/bin/sh -c 'chown -R root:gpio /sys/class/gpio /sys/class/gpio/export /sys/class/gpio/unexport && chmod -R ug+rw  /sys/class/gpio /sys/class/gpio/export /sys/class/gpio/unexport'"

SUBSYSTEM=="gpio", KERNEL=="gpio*", ACTION=="add", RUN+="/bin/chown root:gpio /sys%p/active_low /sys%p/edge /sys%p/direction /sys%p/value", RUN+="/bin/chmod 660 /sys%p/active_low /sys%p/edge /sys%p/direction /sys%p/value"

```
查看板卡信息 gpio pwm:
```bash
$ ls -l /dev/gpiochip*
crw-rw---- 1 root gpio 254, 0 Dec  8 22:32 /dev/gpiochip0
crw-rw---- 1 root gpio 254, 1 Dec  8 22:32 /dev/gpiochip1
crw-rw---- 1 root gpio 254, 2 Dec  8 22:32 /dev/gpiochip2
crw-rw---- 1 root gpio 254, 3 Dec  8 22:32 /dev/gpiochip3
crw-rw---- 1 root gpio 254, 4 Dec  8 22:32 /dev/gpiochip4
crw-rw---- 1 root gpio 254, 5 Dec  8 22:32 /dev/gpiochip5

$ ls -l /sys/class/gpio/
export       gpiochip0/   gpiochip128/ gpiochip32/  gpiochip509/ gpiochip64/  gpiochip96/  unexport   
```

设置uart用户组？不需要
```bash

$ groups $USER # 查询当前用户 所属 用户组
orangepi : orangepi tty disk dialout sudo audio video plugdev games users systemd-journal input netdev ssh bluetooth docker

显示的dialout，就包含 uart 等等 字符设备

$ ls -l /dev/ttyS*
crw-rw---- 1 root dialout 4, 64 Dec  8 20:25 /dev/ttyS0
crw-rw---- 1 root dialout 4, 65 Dec  8 20:25 /dev/ttyS1
crw-rw---- 1 root dialout 4, 67 Dec  8 20:25 /dev/ttyS3
crw-rw---- 1 root dialout 4, 68 Dec  8 20:25 /dev/ttyS4
crw-rw---- 1 root dialout 4, 73 Dec  8 20:25 /dev/ttyS9

已经具备读写权限，无需在添加 用户组 管理权限
```

---
# 项目迁移
启动脚本：
```
#!/bin/bash

source /opt/ros/foxy/setup.sh

# 获取当前脚本所在目录的绝对路径（处理软链接等情况更健壮）
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
echo 'current dir is: '$SCRIPT_DIR

# 获取上一层目录并赋值给一个变量
PARENT_DIR=$(dirname "$SCRIPT_DIR") ## parent dir
echo 'PARENT_DIR is: '$PARENT_DIR
 
ROS_LOG_DIR=$PARENT_DIR/run_log
echo 'ROS_LOG_DIR dir is: '$ROS_LOG_DIR
export ROS_LOG_DIR=$PARENT_DIR/run_log


STEUP_path=$PARENT_DIR/UAV_CAR/install/setup.bash 
echo 'STEUP_path is:'$STEUP_path
source $STEUP_path

ros2 launch uav_car_launch uav_car_drone.launch.py

```

