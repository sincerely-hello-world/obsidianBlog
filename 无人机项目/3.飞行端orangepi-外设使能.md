
## 开发板外设使能

[orangepi 5B 引脚说明图](http://www.orangepi.cn/orangepiwiki/index.php/26_Pin_%E6%8E%A5%E5%8F%A3%E5%BC%95%E8%84%9A%E8%AF%B4%E6%98%8E)

| 用户组  | 序号  | GPIO     | 复用         | 功能描述              | chip | channel |
| ---- | --- | -------- | ---------- | ----------------- | ---- | ------- |
| pwm  | 138 | GPIO4_B2 | PWM14_M1   | 舵机1<br>地盘固定       | 1    | 0       |
| pwm  | 28  | GPIO0_D4 | PWM3_IR_M0 | 舵机2<br>绑激光笔-绿     | 3    | 0       |
| gpio | 54  | GPIO1_C6 |            | 激光笔-红 <br>固定位  定位 |      |         |
| gpio | 35  | GPIO1_A3 |            | 激光笔 -绿<br>舵机头  扫描 |      |         |

| 功能                                                        | 飞行站Linux | 飞控板MCU | 功能                                                        |
| --------------------------------------------------------- | -------: | ------ | --------------------------------------------------------- |
| 1.起飞指令（t265就绪信息）<br>2.飞行位置（t265坐标信息）                      |    uart3 | uart7  | 1.t265就绪信息接收，起飞信号<br>2.t265坐标信息接收                         |
| 1. 发送 路径规划信息<br>2. 发送 飞向动物点指令<br>3. 发送 飞回路径指令<br>4. 发送 降落 |    uart4 | uart2  | 1. 接收 路径规划<br>2. 接收 飞向动物点指令<br>3. 接收 飞回路径指令<br>4. 接收 降落指令 |



## 使能外设-最终的`/boot/orangepiEnv.txt`如下：

开启/使能 开发板uart0 1 3 4 口
开启/使能 开发板pwm通道 pwm3-m0 pwm14-m1 
 

==仅仅追加写入一行：overlays=uart0-m2 uart1-m1 uart3-m0 uart4-m0 pwm3-m0 pwm14-m1 ==
```bash
sudo cp /boot/orangepiEnv.txt /boot/orangepiEnv.txt.copy #备份保存
sudo echo 'overlays=uart0-m2 uart1-m1 uart3-m0 uart4-m0 pwm3-m0 pwm14-m1' >>  /boot/orangepiEnv.txt
```


+ 最终的`/boot/orangepiEnv.txt`如下：
cat  /boot/orangepiEnv.txt
```bash
verbosity=1
bootlogo=true
extraargs=cma=128M
overlay_prefix=rk3588
fdtfile=rockchip/rk3588s-orangepi-5b.dtb
rootdev=UUID=1a81526c-22b9-4b80-94ed-769e3f1c6963
rootfstype=ext4
overlays=uart0-m2 uart1-m1 uart3-m0 uart4-m0 pwm3-m0 pwm14-m1 

# 如果overlays=前面已经有符号，空格间隔 追加写入!
```

-----------------------------
# 要使用             pwm3-m0   pwm14-m1 
# 寄存器度地址分别是： fd8b0030  febf0020
# gpio序号           28        138
# pwmchip组          pwmchip1  pwmchip3
```

 
---

因为 python访问外设，需要root权限，所以脚本需要sudo运行启动脚本。
直接运行，会报错：
```json
[image_processor-5] Traceback (most recent call last):
[image_processor-5]   File "/usr/local/lib/python3.8/dist-packages/periphery/gpio_sysfs.py", line 63, in _open
[image_processor-5]     with open("/sys/class/gpio/export", "w") as f_export:
[image_processor-5] PermissionError: [Errno 13] Permission denied: '/sys/class/gpio/export'

[image_processor-5] During handling of the above exception, another exception occurred:
[image_processor-5]   File "/usr/local/lib/python3.8/dist-packages/periphery/gpio_sysfs.py", line 45, in __init__
[image_processor-5]     self._open(line, direction)
[image_processor-5]   File "/usr/local/lib/python3.8/dist-packages/periphery/gpio_sysfs.py", line 66, in _open
[image_processor-5]     raise GPIOError(e.errno, "Exporting GPIO: " + e.strerror)
[image_processor-5] periphery.gpio.GPIOError: [Errno 13] Exporting GPIO: Permission denied
```

如果可以使用udev规则，修改用户组权限，可以避免这个过程，直接正常启动。

---
 
# 设置udev规则（未完待续）

```bash
echo $USER # 查询当前用户名
groups $USER # 查询当前用户 所属 用户组
# 查询总的 group 配置
# cat /etc/group

# 添加到用户组，设置gpio 和 pwm 用户组
sudo groupadd gpio 
sudo groupadd pwm

sudo usermod -aG gpio,pwm $USER
groups $USER 
```


修改用户组规则

添加这些规则

udev规则目录：cd /etc/udev/rules.d/
udev重载规则： sudo udevadm control --reload-rules && sudo udevadm trigger
udev监视：sudo udevadm monitor  

sudo vi  /etc/udev/rules.d/99-my.rules
```bash
SUBSYSTEM=="gpio", KERNEL=="gpiochip*", MODE="0660", GROUP="gpio" 
# 修改 /dev 下的gpio 权限和所属
# https://docs.linuxkernel.org.cn/userspace-api/gpio/sysfs.html

# export 归属和权限： 匹配的是 gpiochipN 
SUBSYSTEM=="gpio", PROGRAM="/bin/sh -c 'chown -R root:gpio /sys/class/gpio && chmod -R ug+rw /sys/class/gpio'"

#不可行  无效的一条： 貌似
SUBSYSTEM=="gpio", KERNEL=="gpiochip*", PROGRAM="/bin/sh -c '\
	 chown root:gpio /sys/class/gpio/export /sys/class/gpio/unexport && \
	 chmod ug+rw     /sys/class/gpio/export /sys/class/gpio/unexport'"
	
# gpio操作 归属和权限:  匹配的是 gpioN
SUBSYSTEMS=="gpio", KERNELS=="gpiochip*", SUBSYSTEM=="gpio", KERNEL=="gpio*", PROGRAM="/bin/sh -c '\
	chown root:gpio /sys%p /sys%p/active_low /sys%p/direction /sys%p/edge /sys%p/value /sys%p/uevent && \
	chmod ug+rw     /sys%p /sys%p/active_low /sys%p/direction /sys%p/edge /sys%p/value /sys%p/uevent '"

# 如果认为写的粗糙，可以编写shell脚本实现。
SUBSYSTEM=="pwm", KERNEL=="pwmchip*", PROGRAM="/bin/sh -c '\
	chown root:pwm /sys%p/ /sys%p/export  /sys%p/unexport /sys%p/uevent && \
	chmod ug+rw    /sys%p/ /sys%p/export  /sys%p/unexport /sys%p/uevent '" 
# pwm操作 归属和权限	
SUBSYSTEMS=="pwm", KERNELS=="pwmchip*", KERNEL=="pwm*", PROGRAM="/bin/sh -c '\
	chown root:pwm -R /sys%p/  && \
	chmod ug+rw    -R /sys%p/  '"
```


---


```bash
udevadm test --action=add /sys/class/block/sda
```

